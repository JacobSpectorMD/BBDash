{% load staticfiles %}

<style>

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
  font: 10px sans-serif;
}

.cells path {
  fill: none;
  pointer-events: all;
}

.cells :hover circle {
  fill: red;
}

</style>
<script src="{% static 'd3.min.js'%}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
function add_graphics(){
    var products = document.getElementById("product_box").value,
    location = document.getElementById("location_box").value,
    provider = document.getElementById("provider_box").value,
    per_day = document.getElementById("per_day_box").value;
    start_date = document.getElementById("start_date_box").value;
    end_date = document.getElementById("end_date_box").value;

    var criteria = {"products":products, "location":location, "provider":provider, "per_day":per_day,
                    "start_date":start_date, "end_date":end_date};
    
    $.getJSON("/utilization/utilization_data/", criteria, function(utilization_data) {
        var data = JSON.parse(utilization_data);
        $(".new-div").remove();
        if (data.platelets.units.length >0){add_swarm(data.platelets, "platelets")};
        if (data.RBCs.units.length >0){add_swarm(data.RBCs, "RBCs")};
        if (data.plasma.units.length >0){add_swarm(data.plasma, "plasma")};
        if (data.cryo.units.length >0){add_swarm(data.cryo, "cryo")};
    });
}

function add_swarm(data, product){
console.log(data);
if (product=="platelets"){
 var bin_values = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 400, 500, 1000];
 var x_text = "Most recent platelet count";
}

if (product=="RBCs"){
    var bin_values = [2, 3, 4, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10, 10.5, 11, 11.5, 12, 12.5, 13,
                      13.5, 14, 14.5, 15];
     var x_text = "Most recent hemoglobin";
}

if (product=="plasma"){
    var bin_values = [0, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 28, 30, 32,
                      34, 36, 40, 44, 60, 80, 100];
    var x_text = "Most recent prothrombin time";
}

if (product=="cryo"){
    var bin_values = [0, 25, 50, 75, 100, 125, 150, 175, 200, 225];
     var x_text = "Most recent fibrinogen";
}

        
document.getElementById("body").setAttribute("style", "overflow-y:scroll");                
var new_div = d3.select("#wrapper")
    .append("div")
    .style("grid-column", "1/7")
    .attr("class", "new-div")
var margin = {top:10, right:30, bottom:45, left:40};
var width = 0.9*document.getElementById("wrapper").offsetWidth;
var height = 500 - margin.top - margin.bottom;

var x = d3.scaleBand()
    .rangeRound([0, width])
    .domain(bin_values);

var xAxis = d3.axisBottom(x);

var svg = new_div.append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

var x_label = svg.append("text")
    .attr("y", function (){return height+margin.top+35})
    .attr("x", function (){return (width-margin.left-margin.right)/2})
    .attr("dominant-baseline", "baseline")
    .text(x_text);

var all_box = svg.append("rect")
    .attr("y", margin.top+20)
    .attr("x", width*0.8-5)
    .style("fill", "none")
    .style("stroke-width", 1)
    .style("stroke", "black")
    .attr("height", 50)
    .attr("width", 200);

svg.append("text")
    .attr("y", margin.top+15)
    .attr("x", width*0.8)
    .text("Statistics for all products");

var min = svg.append("text")
    .attr("y", margin.top+35)
    .attr("x", width*0.8)
    .text(function(){
        return "Minimum: "+data.min})

var median = svg.append("text")
    .attr("y", margin.top+50)
    .attr("x", width*0.8)
    .text(function(){
        return "Median: "+data.median})

var max = svg.append("text")
    .attr("y", margin.top+65)
    .attr("x", width*0.8)
    .text(function(){
        return "Maximum: "+data.max})

var g = svg.append("g")
    .attr("transform", "translate("+margin.left+","+margin.top+")");

var histogram = d3.histogram()
    .value(function(d){return d.value;})
    .thresholds(bin_values);
    
var bins = histogram(data.units);
var list_length = d3.max(bins, function(d){
    return d.length;
    });

var domain_factor = list_length*(height+margin.top)/(4+6.5*(list_length/5));


var y = d3.scaleLinear()
    .range([height+margin.top, margin.top])
    .domain([0,domain_factor]);

var tick_spacing = 0.8*width/(width/bin_values.length);

bins[bins.length-1].x1 = bin_values[bin_values.length-1];

var circleG = g.selectAll(".circle")
    .data(bins)
    .enter()
    .append("g")
        .attr("class", "circle-g")       
        .attr("transform", function(d, i){return "translate("+(x(d.x1)-tick_spacing)+","+height+")"});
        
var circles = circleG.selectAll("circle")
    .data(d=>d.map((p, i)=>{
            return{
            idx:i, 
            value:p.value, 
            color:p.color
    }}) )
    .enter()
    .append("circle")
    .attr("cx", function (d) {return 4+6.5*(d.idx%5);})
    .attr("cy", function (d) {return 2+6.5*(-Math.ceil((1+d.idx)/5))})
    .attr("r", 3)
    .attr("data-value", function(d){return d.value})
    .style("fill", function(d) { return d.color; });
    
g.append("g")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0,"+height+")")
    .call(xAxis);
    
g.append("g")
    .call(d3.axisLeft(y))
    .attr("transform", "translate(0,-10)");
}


</script>