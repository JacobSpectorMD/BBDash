<style>

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.axis text {
  font: 10px sans-serif;
}

.cells path {
  fill: none;
  pointer-events: all;
}

.cells :hover circle {
  fill: red;
}

</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
function add_graphics(){
    var products = document.getElementById("product_box").value,
    location = document.getElementById("location_box").value,
    provider = document.getElementById("provider_box").value,
    per_day = document.getElementById("per_day_box").value;
    start_date = document.getElementById("start_date_box").value;
    end_date = document.getElementById("end_date_box").value;

    var criteria = {"products":products, "location":location, "provider":provider, "per_day":per_day,
                    "start_date":start_date, "end_date":end_date};
    
    $.getJSON("/utilization/utilization_data/", criteria, function(utilization_data) {
        var data = JSON.parse(utilization_data);
        console.log(data);
        $(".new-div").remove();
        if (data.platelets.length >0){add_swarm(data.platelets, "platelets")};
        if (data.RBCs.length >0){add_swarm(data.RBCs, "RBCs")};
    });
}

function add_swarm(data, product){
if (product=="platelets"){
 var bin_values = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 200, 300, 400, 500, 1000]      
}

if (product=="RBCs"){
    var bin_values = [2, 3, 4, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10, 10.5, 11, 11.5, 12, 12.5, 13,
                      13.5, 14, 14.5, 15]
}

        
document.getElementById("body").setAttribute("style", "overflow-y:scroll");                
var new_div = d3.select("#wrapper")
    .append("div")
    .style("grid-column", "1/8")
    .attr("class", "new-div")
var margin = {top:10, right:30, bottom:30, left:40};
var width = 0.9*document.getElementById("wrapper").offsetWidth;
var height = 500 - margin.top - margin.bottom;

var x = d3.scaleBand()
    .rangeRound([0, width])
    .domain(bin_values);

var xAxis = d3.axisBottom(x);

var svg = new_div.append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

var g = svg.append("g")
    .attr("transform", "translate("+margin.left+","+margin.top+")");

var histogram = d3.histogram()
    .value(function(d){return d.value;})
    .thresholds(bin_values);
    
var bins = histogram(data);

var y = d3.scaleLinear()
    .range([height+margin.top, margin.top])
    .domain([0, d3.max(bins, function(d){return d.length;})]);

console.log(bins);
var tick_spacing = 0.8*width/(width/bin_values.length);

bins[bins.length-1].x1 = bin_values[bin_values.length-1];

var circleG = g.selectAll(".circle")
    .data(bins)
    .enter()
    .append("g")
        .attr("class", "circle-g")       
        .attr("transform", function(d, i){return "translate("+(x(d.x1)-tick_spacing)+","+height+")"});
        
var bees = circleG.selectAll("image")
    .data(d=>d.map((p, i)=>{
            return{
            idx:i, 
            value:p.value, 
            color:p.color
    }}) )
    .enter()
    .append("svg:image")
    .attr("width", 20)
    .attr("height", 20)
    .attr("xlink:href", "/static/bee.svg")
    .attr("x", function (d) {return 4+20*(d.idx%3);})
    .attr("y", function (d) {return 2+20*(-Math.ceil((1+d.idx)/3))});
    
g.append("g")
    .attr("class", "axis axis--x")
    .attr("transform", "translate(0,"+height+")")
    .call(xAxis);
    
g.append("g")
    .call(d3.axisLeft(y))
    .attr("transform", "translate(0,-10)");
}


</script>